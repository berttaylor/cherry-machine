<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cherry Machine - Classroom Spinner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        .screen.active {
            display: block;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        /* Setup Screen */
        .setup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .list-group {
            display: flex;
            flex-direction: column;
        }

        .list-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 1.1em;
        }

        .list-group textarea {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1em;
            min-height: 150px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .list-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .setup-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* Game Screen */
        .game-screen {
            text-align: center;
        }

        .reels-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin: 40px auto;
            max-width: 1200px;
            padding: 0 20px;
        }

        .reel {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 50%, #e9ecef 100%);
            border: 5px solid #2c3e50;
            border-radius: 20px;
            width: 100%;
            min-height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: visible;
            box-shadow:
                inset 0 2px 4px rgba(255, 255, 255, 0.8),
                inset 0 -2px 4px rgba(0, 0, 0, 0.1),
                0 8px 16px rgba(0, 0, 0, 0.2);
            padding-top: 50px;
        }

        .reel-content {
            font-size: clamp(0.75em, 3vw, 1.4em);
            font-weight: bold;
            color: #2c3e50;
            padding: 30px 20px;
            word-wrap: break-word;
            word-break: break-word;
            text-align: center;
            position: relative;
            z-index: 2;
            width: 100%;
            line-height: 1.3;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .reel.spinning .reel-content {
            animation: spin 0.1s linear infinite;
        }

        @keyframes spin {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .reel-label {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: clamp(0.65em, 1.5vw, 0.85em);
            font-weight: bold;
            z-index: 3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            max-width: 90%;
        }

        .game-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-spin {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 2em;
            padding: 20px 60px;
        }

        .btn-spin:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
        }

        .btn-spin:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 12px 25px;
            font-size: 1em;
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .reels-container {
                gap: 20px;
            }

            .reel {
                min-height: 280px;
            }

            .reel-content {
                font-size: clamp(0.7em, 2.5vw, 1.2em);
                padding: 25px 15px;
            }
        }

        @media (max-width: 900px) {
            .reels-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 25px;
                max-width: 600px;
            }

            .reel {
                min-height: 300px;
            }

            .reel-content {
                font-size: clamp(0.75em, 4vw, 1.3em);
                padding: 30px 20px;
            }

            h1 {
                font-size: 2em;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .screen {
                padding: 20px;
            }

            .reels-container {
                gap: 20px;
                padding: 0 10px;
            }

            .reel {
                min-height: 260px;
            }

            .reel-content {
                font-size: clamp(0.65em, 4vw, 1.1em);
                padding: 25px 15px;
            }

            .reel-label {
                padding: 6px 15px;
                top: 12px;
            }

            h1 {
                font-size: 1.5em;
            }

            .btn-spin {
                font-size: 1.5em;
                padding: 15px 40px;
            }
        }

        @media (max-width: 400px) {
            .reel {
                min-height: 240px;
            }

            .reel-content {
                font-size: clamp(0.6em, 4vw, 1em);
                padding: 20px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div id="setupScreen" class="screen active">
            <h1><R Cherry Machine Setup</h1>
            <div class="setup-grid">
                <div class="list-group">
                    <label for="studentsList">Students</label>
                    <textarea id="studentsList" placeholder="Enter student names..."></textarea>
                </div>
                <div class="list-group">
                    <label for="directionList">Count Direction</label>
                    <textarea id="directionList">Count on
Count back</textarea>
                </div>
                <div class="list-group">
                    <label for="stepList">Step Size</label>
                    <textarea id="stepList">5
10
20
100</textarea>
                </div>
                <div class="list-group">
                    <label for="mannerList">Manner of Counting</label>
                    <textarea id="mannerList">Individually
Nominate someone
With your team
Nominate another team
As a class</textarea>
                </div>
            </div>
            <div class="setup-buttons">
                <button class="btn btn-primary" id="startGameBtn" disabled>Start Game</button>
                <button class="btn btn-secondary" id="resetBtn">Reset to Defaults</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <h1><R Cherry Machine</h1>
            <div class="reels-container">
                <div class="reel" id="reel1">
                    <div class="reel-label">Student</div>
                    <div class="reel-content">?</div>
                </div>
                <div class="reel" id="reel2">
                    <div class="reel-label">Direction</div>
                    <div class="reel-content">?</div>
                </div>
                <div class="reel" id="reel3">
                    <div class="reel-label">Step Size</div>
                    <div class="reel-content">?</div>
                </div>
                <div class="reel" id="reel4">
                    <div class="reel-label">Manner</div>
                    <div class="reel-content">?</div>
                </div>
            </div>
            <div class="game-buttons">
                <button class="btn btn-spin" id="spinBtn">SPIN</button>
                <button class="btn btn-secondary btn-small" id="respinStudentBtn">Re-spin Student Only</button>
                <button class="btn btn-secondary btn-small" id="backToSetupBtn">Back to Setup</button>
            </div>
        </div>
    </div>

    <script>
        // Create a single shared AudioContext
        let audioContext = null;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // Resume context if it's suspended (browser autoplay policy)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            return audioContext;
        }

        // Generate sound effects using Web Audio API
        function generateTick(reelIndex = 0) {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            // Different pitch for each reel to avoid clipping when layered
            const frequencies = [700, 850, 1000, 1150];
            oscillator.frequency.value = frequencies[reelIndex] || 800;
            oscillator.type = 'sine';

            const now = ctx.currentTime;
            // Reduce volume to prevent clipping when multiple reels play
            gainNode.gain.setValueAtTime(0.15, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.03);

            oscillator.start(now);
            oscillator.stop(now + 0.03);
        }

        function generateClick() {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            oscillator.frequency.value = 400;
            oscillator.type = 'sine';

            const now = ctx.currentTime;
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);

            oscillator.start(now);
            oscillator.stop(now + 0.1);
        }

        // App state
        const state = {
            students: [],
            directions: [],
            steps: [],
            manners: [],
            lastResult: null,
            isSpinning: false
        };

        // DOM elements
        const setupScreen = document.getElementById('setupScreen');
        const gameScreen = document.getElementById('gameScreen');
        const studentsList = document.getElementById('studentsList');
        const directionList = document.getElementById('directionList');
        const stepList = document.getElementById('stepList');
        const mannerList = document.getElementById('mannerList');
        const startGameBtn = document.getElementById('startGameBtn');
        const resetBtn = document.getElementById('resetBtn');
        const spinBtn = document.getElementById('spinBtn');
        const respinStudentBtn = document.getElementById('respinStudentBtn');
        const backToSetupBtn = document.getElementById('backToSetupBtn');
        const reels = [
            document.getElementById('reel1'),
            document.getElementById('reel2'),
            document.getElementById('reel3'),
            document.getElementById('reel4')
        ];

        // Utility functions
        function parseList(text) {
            return text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
        }

        function validateLists() {
            const students = parseList(studentsList.value);
            const directions = parseList(directionList.value);
            const steps = parseList(stepList.value);
            const manners = parseList(mannerList.value);

            const isValid = students.length > 0 &&
                          directions.length > 0 &&
                          steps.length > 0 &&
                          manners.length > 0;

            startGameBtn.disabled = !isValid;
        }

        function saveToLocalStorage() {
            const config = {
                students: studentsList.value,
                directions: directionList.value,
                steps: stepList.value,
                manners: mannerList.value
            };
            localStorage.setItem('cherryMachineConfig', JSON.stringify(config));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('cherryMachineConfig');
            if (saved) {
                const config = JSON.parse(saved);
                studentsList.value = config.students || '';
                directionList.value = config.directions || directionList.value;
                stepList.value = config.steps || stepList.value;
                mannerList.value = config.manners || mannerList.value;
            }
        }

        function resetToDefaults() {
            studentsList.value = '';
            directionList.value = 'Count on\nCount back';
            stepList.value = '5\n10\n20\n100';
            mannerList.value = 'Individually\nNominate someone\nWith your team\nNominate another team\nAs a class';
            validateLists();
        }

        function randomChoice(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function updateReelContent(reelIndex, text) {
            const content = reels[reelIndex].querySelector('.reel-content');
            content.textContent = text;
        }

        function generateResult(respinStudentOnly = false) {
            let result;
            let attempts = 0;

            do {
                result = {
                    student: respinStudentOnly && state.lastResult ? state.lastResult.student : randomChoice(state.students),
                    direction: respinStudentOnly && state.lastResult ? state.lastResult.direction : randomChoice(state.directions),
                    step: respinStudentOnly && state.lastResult ? state.lastResult.step : randomChoice(state.steps),
                    manner: respinStudentOnly && state.lastResult ? state.lastResult.manner : randomChoice(state.manners)
                };

                if (respinStudentOnly) {
                    result.student = randomChoice(state.students);
                }

                attempts++;
            } while (
                state.lastResult &&
                result.student === state.lastResult.student &&
                result.direction === state.lastResult.direction &&
                result.step === state.lastResult.step &&
                result.manner === state.lastResult.manner &&
                attempts < 2
            );

            return result;
        }

        async function animateReel(reelIndex, finalValue, delay) {
            return new Promise(resolve => {
                setTimeout(() => {
                    const reel = reels[reelIndex];
                    const content = reel.querySelector('.reel-content');
                    reel.classList.add('spinning');

                    // Get the appropriate list for this reel
                    let list;
                    switch(reelIndex) {
                        case 0: list = state.students; break;
                        case 1: list = state.directions; break;
                        case 2: list = state.steps; break;
                        case 3: list = state.manners; break;
                    }

                    // Animate with random values
                    let iterations = 0;
                    const maxIterations = 20 + Math.floor(Math.random() * 10);
                    // Vary the interval speed per reel (85-115ms range)
                    const intervalSpeed = 85 + (reelIndex * 7) + Math.floor(Math.random() * 10);
                    const interval = setInterval(() => {
                        content.textContent = randomChoice(list);

                        // Play tick sound on each iteration with reel-specific pitch
                        try {
                            generateTick(reelIndex);
                        } catch (e) {}

                        iterations++;

                        if (iterations >= maxIterations) {
                            clearInterval(interval);
                            reel.classList.remove('spinning');
                            content.textContent = finalValue;

                            // Play click sound when reel stops
                            try {
                                generateClick();
                            } catch (e) {}

                            resolve();
                        }
                    }, intervalSpeed);
                }, delay);
            });
        }

        async function spin(respinStudentOnly = false) {
            if (state.isSpinning) return;

            state.isSpinning = true;
            spinBtn.disabled = true;
            respinStudentBtn.disabled = true;

            // Generate result
            const result = generateResult(respinStudentOnly);

            // Animate reels sequentially
            const delays = respinStudentOnly ? [0] : [0, 600, 1200, 1800];
            const values = [result.student, result.direction, result.step, result.manner];

            if (respinStudentOnly) {
                await animateReel(0, result.student, 0);
            } else {
                await Promise.all([
                    animateReel(0, result.student, delays[0]),
                    animateReel(1, result.direction, delays[1]),
                    animateReel(2, result.step, delays[2]),
                    animateReel(3, result.manner, delays[3])
                ]);
            }

            state.lastResult = result;

            state.isSpinning = false;
            spinBtn.disabled = false;
            respinStudentBtn.disabled = false;
        }

        function startGame() {
            // Parse and save lists
            state.students = parseList(studentsList.value);
            state.directions = parseList(directionList.value);
            state.steps = parseList(stepList.value);
            state.manners = parseList(mannerList.value);

            // Save to localStorage
            saveToLocalStorage();

            // Switch to game screen
            setupScreen.classList.remove('active');
            gameScreen.classList.add('active');

            // Reset reels
            reels.forEach((reel, i) => {
                updateReelContent(i, '?');
            });
            state.lastResult = null;
        }

        function backToSetup() {
            gameScreen.classList.remove('active');
            setupScreen.classList.add('active');
        }

        // Event listeners
        studentsList.addEventListener('input', validateLists);
        directionList.addEventListener('input', validateLists);
        stepList.addEventListener('input', validateLists);
        mannerList.addEventListener('input', validateLists);

        startGameBtn.addEventListener('click', startGame);
        resetBtn.addEventListener('click', resetToDefaults);
        spinBtn.addEventListener('click', () => spin(false));
        respinStudentBtn.addEventListener('click', () => spin(true));
        backToSetupBtn.addEventListener('click', backToSetup);

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (gameScreen.classList.contains('active') && e.code === 'Space' && !state.isSpinning) {
                e.preventDefault();
                spin(false);
            }
        });

        // Initialize
        loadFromLocalStorage();
        validateLists();
    </script>
</body>
</html>
